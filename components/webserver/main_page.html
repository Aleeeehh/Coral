<!DOCTYPE html>
<html>
<head>
<title> ESP32 - CAM</title>
<meta charset = 'UTF-8'>
<style>
body
{
    font-family : Arial, sans-serif;
    text-align : center;
margin:
    20px;
    background-color : #f0f0f0;
}
.container
{
    max-width : 800px;
margin:
    0 auto;
    background-color : white;
padding:
    20px;
    border-radius : 10px;
    box-shadow : 0 2px 10px rgba(0, 0, 0, 0.1);
}
.photo-container
{
margin:
    20px;
padding:
    10px;
border:
    2px solid #ccc;
display:
    inline-block;
    border-radius : 5px;
}
.stream-container
{
margin:
    20px;
padding:
    10px;
border:
    2px solid #0066cc;
display:
    inline-block;
    border-radius : 5px;
}
button
{
padding:
    15px 30px;
    font-size : 18px;
margin:
    10px;
border:
    none;
cursor:
    pointer;
    border-radius : 5px;
transition:
    background-color 0.3s;
}
.photo-btn
{
    background-color : #4CAF50;
color:
    white;
}
.photo-btn : hover
{
    background-color : #45a049;
}
.stream-btn
{
    background-color : #0066cc;
color:
    white;
}
.stream-btn : hover
{
    background-color : #0052a3;
}
.inference-btn
{
    background-color : #FF6B35;
color:
    white;
}
.inference-btn : hover
{
    background-color : #E55A2B;
}
.status
{
margin:
    10px;
padding:
    10px;
    border-radius : 5px;
    font-weight : bold;
}
.resolution {
    background: #f0f0f0;
    padding: 8px;
    border-radius: 4px;
    margin: 10px 0;
    font-weight: bold;
    text-align: center;
}
.status.connected
{
    background-color : #d4edda;
color:
# 155724;
    border:
        1px solid #c3e6cb;
    }
    .status.disconnected
{
    background-color : #f8d7da;
    color : #721c24;
    border : 1px solid #f5c6cb;
}
.status.face-detected
{
    background-color : #d4edda;
    color : #155724;
    border : 1px solid #c3e6cb;
}
.status.no-face
{
    background-color : #fff3cd;
    color : #856404;
    border : 1px solid #ffeaa7;
}
.status.error
{
    background-color : #f8d7da;
    color : #721c24;
    border : 1px solid #f5c6cb;
}
    #face-overlay {
    position: absolute;
    border: 3px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    pointer-events: none; 
    z-index: 10;
}
    </style>
        <script>
            window.onload = function()
    {
        updatePhoto();
    };

    function updatePhoto()
    {
        var img = document.getElementById('photo');
        if (img)
        {
            console.log('Aggiornamento foto...');
            img.src = '/photo?t=' + Date.now();
            img.onload = function()
            {
                console.log('‚úÖ Foto caricata con successo');
                img.style.display = 'block';
            };
            img.onerror = function()
            {
                console.log('‚ùå Errore caricamento foto');
                img.style.display = 'none';
            };
        }
        else
        {
            console.log('‚ùå Elemento img#photo non trovato');
        }
    }

    // Funzione per ottenere la risoluzione corrente
    async function getCurrentResolution() {
    try {
        const response = await fetch('/resolution/current');
        const data = await response.json();
        document.getElementById('resolution').textContent = 
            `Risoluzione: ${data.width}x${data.height}`;
    } catch (error) {
        console.error('Errore nel caricamento risoluzione:', error);
        document.getElementById('resolution').textContent = 'Risoluzione: Errore';
    }
}

// Chiama la funzione quando la pagina si carica
window.onload = function() {
    getCurrentResolution();
};
    


async function changeResolution(direction) {
    try {
        const response = await fetch(`/change_resolution?direction=${direction}`, { 
            method: 'POST' 
        });
        const data = await response.json();
        
        // Aggiorna il display della risoluzione
        document.getElementById('resolution').textContent = 
            `Risoluzione: ${data.width}x${data.height}`;
            
        // Mostra feedback
        const action = direction === 0 ? 'diminuita' : 'aumentata';
        document.getElementById('status').textContent = 
            `Risoluzione ${action} a ${data.width}x${data.height}`;
            
    } catch (error) {
        document.getElementById('status').textContent = 'Errore nel cambio risoluzione';
    }
}

// Funzioni wrapper per i bottoni
function incrementResolution() {
    changeResolution(1);
}

function decrementResolution() {
    changeResolution(0);
}

    function detectFace()
    {
        console.log('ü§ñ Avvio rilevamento faccia...');
        
        fetch('/inference', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ Risultato inferenza:', data);
            
            if (data.success) {
                const result = data.face_detected ? '‚úÖ FACCIA RILEVATA' : '‚ùå NESSUNA FACCIA';
                const confidence = (data.confidence * 100).toFixed(1);
                const statusDiv = document.getElementById('status');
                
                // Aggiorna il div status con il risultato
                statusDiv.textContent = `${result} | Confidence: ${confidence}% | Tempo: ${data.inference_time_ms}ms | Memoria: ${data.memory_used_kb}KB`;
                
                // Applica la classe CSS appropriata
                statusDiv.className = 'status ' + (data.face_detected ? 'face-detected' : 'no-face');
                
                // Disegna il rettangolo se una faccia √® stata rilevata
                if (data.face_detected && data.bounding_box) {
                    drawFaceBox(data.bounding_box);
                } else {
                    hideFaceBox();
                }
                // Aggiorna la foto
                updatePhoto();
            } else {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = '‚ùå Errore durante l\'inferenza';
                statusDiv.className = 'status error';
            }
        })
        .catch(error => {
            console.error('‚ùå Errore inferenza:', error);
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = '‚ùå Errore di connessione';
            statusDiv.className = 'status error';
        });
    }

    function drawFaceBox(boundingBox) {
        const overlay = document.getElementById('face-overlay');
        const img = document.getElementById('photo');
        const container = document.getElementById('photo-container');
        
        if (img.complete && img.naturalWidth > 0) {
            // Ottieni le posizioni relative
            const imgRect = img.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // Calcola offset del contenitore
            const offsetX = imgRect.left - containerRect.left;
            const offsetY = imgRect.top - containerRect.top;
            
            // Calcola scala
            const scaleX = imgRect.width / img.naturalWidth;
            const scaleY = imgRect.height / img.naturalHeight;
            
            // Applica coordinate
            const x = (boundingBox[0] * scaleX) + offsetX;
            const y = (boundingBox[1] * scaleY) + offsetY;
            const width = (boundingBox[2] - boundingBox[0]) * scaleX;
            const height = (boundingBox[3] - boundingBox[1]) * scaleY;
            
            overlay.style.left = x + 'px';
            overlay.style.top = y + 'px';
            overlay.style.width = width + 'px';
            overlay.style.height = height + 'px';
            overlay.style.display = 'block';
            
            console.log(`üéØ Debug: imgRect(${imgRect.left},${imgRect.top}), containerRect(${containerRect.left},${containerRect.top})`);
            console.log(`üîç Offset: (${offsetX}, ${offsetY}), Scale: (${scaleX}, ${scaleY})`);
        }
    }


function hideFaceBox() {
    const overlay = document.getElementById('face-overlay');
    overlay.style.display = 'none';
}

async function capturePhoto() {
    try {
        const response = await fetch('/capture');
        const data = await response.json();
        
        if (data.success) {
            // Aggiorna l'immagine dopo lo scatto
            updatePhoto();
            hideFaceBox();
            
            // Mostra feedback
            document.getElementById('status').textContent = '‚úÖ Foto scattata con successo!';
            document.getElementById('status').className = 'status connected';
        } else {
            document.getElementById('status').textContent = '‚ùå Errore nello scatto foto';
            document.getElementById('status').className = 'status error';
        }
    } catch (error) {
        console.error('Errore scatto foto:', error);
        document.getElementById('status').textContent = '‚ùå Errore di connessione';
        document.getElementById('status').className = 'status error';
    }
}

    </script>
</head>
<body>
    <div class="container">
        <h1>üì∑ ESP32-CAM</h1>
        <div id="status" class="status"></div>
        <div id="resolution" class="resolution">Risoluzione: </div>
        <p>
            <button class="photo-btn" onclick="capturePhoto()">üì∏ Scatta Foto</button>
            <button class="inference-btn" onclick="detectFace()">ü§ñ Detect Face</button>
            <button onclick="changeResolution(1)">‚¨ÜÔ∏è Aumenta Risoluzione</button>
            <button onclick="changeResolution(0)">‚¨áÔ∏è Diminuisci Risoluzione</button>
        </p>
        <div id="photo-container" class="photo-container" style="position: relative;">
            <h3>Ultima Foto Scattata:</h3>
            <img id="photo" style="max-width: 100%; max-height: 400px;">
            <div id="face-overlay" style="position: absolute; border: 3px solid white; display: none;"></div>
        </div>
    </div>
</body>
</html>